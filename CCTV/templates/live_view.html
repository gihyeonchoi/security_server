<!-- CCTV/templates/live_view.html -->
{% extends 'base.html' %}

{% block title %}ë¼ì´ë¸Œ ëª¨ë‹ˆí„°ë§{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/live_view.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="live-header">
        <h2>ì‹¤ì‹œê°„ CCTV ëª¨ë‹ˆí„°ë§</h2>
        <div class="header-controls">
            <select id="layoutSelect" class="control-select">
                <option value="1">1ê°œ í™”ë©´</option>
                <option value="4" selected>4ê°œ í™”ë©´</option>
                <option value="9">9ê°œ í™”ë©´</option>
            </select>
            <button id="toggleAllDetection" class="btn btn-primary">ì „ì²´ AI ë¶„ì„ ì‹œì‘</button>
            <button id="stopAllDetection" class="btn btn-secondary">ì „ì²´ ì¤‘ì§€</button>
        </div>
    </div>
    
    <div id="cameraGrid" class="camera-live-grid grid-4">
        {% for camera in cameras %}
        {% if camera.is_active %}
        <div class="live-camera-item" data-camera-id="{{ camera.id }}">
            <div class="camera-title">
                <span class="camera-name">{{ camera.name }}</span>
                <span class="status-indicator" id="status-{{ camera.id }}">â—</span>
                <span class="websocket-status" id="ws-status-{{ camera.id }}">ğŸ”´</span>
            </div>
            <div class="video-container">
                <canvas id="canvas-{{ camera.id }}" class="camera-canvas"></canvas>
                <div class="loading-overlay" id="loading-{{ camera.id }}">
                    <div class="spinner"></div>
                    <p>Pipeline ì—°ê²° ì¤‘...</p>
                </div>
                <div class="detection-overlay" id="detection-{{ camera.id }}"></div>
            </div>
            <div class="camera-controls">
                <button onclick="toggleDetection({{ camera.id }})" class="btn-icon" title="ê°ì§€ ì‹œì‘/ì¤‘ì§€">
                    <span id="detection-toggle-{{ camera.id }}">â–¶ï¸</span>
                </button>
                <button onclick="fullscreenCamera({{ camera.id }})" class="btn-icon" title="ì „ì²´í™”ë©´">
                    ğŸ”³
                </button>
                <button onclick="captureSnapshot({{ camera.id }})" class="btn-icon" title="ìŠ¤ëƒ…ìƒ·">
                    ğŸ“·
                </button>
                <span class="pipeline-status" id="pipeline-status-{{ camera.id }}">ì¤‘ì§€ë¨</span>
            </div>
            <div class="detection-info" id="info-{{ camera.id }}">
                <p>ê°ì§€ëœ ê°ì²´: <span id="object-count-{{ camera.id }}">0</span></p>
                <p>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-update-{{ camera.id }}">-</span></p>
                <div id="detection-list-{{ camera.id }}" class="detection-list"></div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
    
    <!-- ì „ì²´í™”ë©´ ëª¨ë‹¬ -->
    <div id="fullscreenModal" class="fullscreen-modal">
        <div class="fullscreen-header">
            <h3 id="fullscreenTitle"></h3>
            <button onclick="closeFullscreen()" class="btn btn-sm">ë‹«ê¸°</button>
        </div>
        <canvas id="fullscreenCanvas" class="fullscreen-canvas"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/live_view.js' %}"></script>
<script>
    // ì¹´ë©”ë¼ ì„¤ì • ë°ì´í„° ì „ë‹¬
    const cameraConfigs = {
        {% for camera in cameras %}
        {% if camera.is_active %}
        {{ camera.id }}: {
            name: "{{ camera.name }}",
            rtspUrl: "{{ camera.rtsp_url }}",
            maxFps: {{ camera.max_fps }},
            apiKey: "{{ camera.api_key }}",
            workspaceName: "{{ camera.workspace_name }}",
            workflowId: "{{ camera.workflow_id }}"
        },
        {% endif %}
        {% endfor %}
    };
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        initializeLiveViewWithWebSocket(cameraConfigs);
    });
</script>
{% endblock %}